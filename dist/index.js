import{resolve as t,relative as e}from"path";import{readdirSync as n,statSync as u}from"fs";function s(s={}){const{viewsDir:i="src/views",chunkPrefix:c="page-",include:a=["index.vue"],exclude:l=[],chunkFileNames:r={pageChunkPath:"assets/js/pages/[name]-[hash].js",defaultChunkPath:"assets/js/[name]-[hash].js"}}=s;return{name:"vite-plugin-unique-page-chunks",config(s,{command:p}){if("build"!==p)return;const h=function(s,i,c,a){const l={},r=t(process.cwd(),s);try{n(r).forEach(p=>{const h=t(r,p);if(!u(h).isDirectory())return;if(a.includes(p))return;const f=n(h).filter(t=>c.some(e=>{if(e.includes("*")){return new RegExp(e.replace(/\*/g,".*")).test(t)}return t===e}));if(f.length>0){const n=`${i}${p.toLowerCase()}`;l[n]=f.map(t=>`./${s}/${p}/${t}`.replace(/\\/g,"/"));["components","composables","utils"].forEach(s=>{const i=t(h,s);try{if(u(i).isDirectory()){o(i).forEach(t=>{const u=e(process.cwd(),t).replace(/\\/g,"/");l[n].push(`./${u}`)})}}catch(t){}})}})}catch(t){console.warn(`⚠️  [unique-page-chunks] 无法扫描目录 ${s}:`,t.message)}return l}(i,c,a,l);s.build||(s.build={}),s.build.rollupOptions||(s.build.rollupOptions={}),s.build.rollupOptions.output||(s.build.rollupOptions.output={});const f=s.build.rollupOptions.output.manualChunks||{};if("function"==typeof f){const t=f;s.build.rollupOptions.output.manualChunks=e=>{for(const[t,n]of Object.entries(h))if(n.some(t=>e.includes(t)))return t;return t(e)}}else s.build.rollupOptions.output.manualChunks={...f,...h};const d=s.build.rollupOptions.output.chunkFileNames;if("function"==typeof d){const t=d;s.build.rollupOptions.output.chunkFileNames=e=>e.name&&e.name.startsWith(c)?r.pageChunkPath:t(e)}else s.build.rollupOptions.output.chunkFileNames="string"==typeof d?t=>t.name&&t.name.startsWith(c)?r.pageChunkPath:d:t=>t.name&&t.name.startsWith(c)?r.pageChunkPath:r.defaultChunkPath;console.log(`🚀 [unique-page-chunks] 自动生成了 ${Object.keys(h).length} 个页面chunks:`),Object.keys(h).forEach(t=>{console.log(`   - ${t}`)}),console.log(`📁 [unique-page-chunks] 页面chunk将保存到: ${r.pageChunkPath}`)}}}function o(e){const s=[];try{n(e).forEach(n=>{const i=t(e,n);u(i).isDirectory()?s.push(...o(i)):(n.endsWith(".vue")||n.endsWith(".js")||n.endsWith(".ts"))&&s.push(i)})}catch(t){}return s}export{s as default,s as uniquePageChunks};
