import{resolve as t,relative as n}from"path";import{readdirSync as u,statSync as e}from"fs";function s(s={}){const{viewsDir:i="src/views",chunkPrefix:l="page-",include:c=["index.vue"],exclude:r=[],chunkFileNames:p={pageChunkPath:"assets/js/pages/[name]-[hash].js",defaultChunkPath:"assets/js/[name]-[hash].js"},pluginPriority:a=!0}=s;return{name:"vite-plugin-unique-page-chunks",config(s,{command:h}){if("build"!==h)return;const f=function(s,i,l,c){const r={},p=t(process.cwd(),s);try{u(p).forEach(a=>{const h=t(p,a);if(!e(h).isDirectory())return;if(c.includes(a))return;const f=u(h).filter(t=>l.some(n=>{if(n.includes("*")){return new RegExp(n.replace(/\*/g,".*")).test(t)}return t===n}));if(f.length>0){const u=`${i}${a.toLowerCase()}`;r[u]=f.map(t=>`./${s}/${a}/${t}`.replace(/\\/g,"/"));["components","composables","utils"].forEach(s=>{const i=t(h,s);try{if(e(i).isDirectory()){o(i).forEach(t=>{const e=n(process.cwd(),t).replace(/\\/g,"/");r[u].push(`./${e}`)})}}catch(t){}})}})}catch(t){console.warn(`⚠️  [unique-page-chunks] 无法扫描目录 ${s}:`,t.message)}return r}(i,l,c,r);s.build||(s.build={}),s.build.rollupOptions||(s.build.rollupOptions={}),s.build.rollupOptions.output||(s.build.rollupOptions.output={});const d=s.build.rollupOptions.output.manualChunks||{};if("function"==typeof d){const t=d,u=t=>{const u=`./${n(process.cwd(),t).replace(/\\/g,"/")}`;for(const[t,n]of Object.entries(f))if(n.includes(u))return t;return null};s.build.rollupOptions.output.manualChunks=n=>a?u(n)||t(n):t(n)||u(n)}else s.build.rollupOptions.output.manualChunks=a?{...d,...f}:{...f,...d};const g=s.build.rollupOptions.output.chunkFileNames,m=t=>null!=t&&t.name.startsWith(l)?p.pageChunkPath:null;if("function"==typeof g){const t=g;s.build.rollupOptions.output.chunkFileNames=n=>m(n)||t(n)}else s.build.rollupOptions.output.chunkFileNames="string"==typeof g?t=>m(t)||g:t=>m(t)||p.defaultChunkPath;console.log(`🚀 [unique-page-chunks] 自动生成了 ${Object.keys(f).length} 个页面chunks:`),Object.keys(f).forEach(t=>{console.log(`   - ${t}`)}),console.log(`📁 [unique-page-chunks] 页面chunk将保存到: ${p.pageChunkPath}`)}}}function o(n){const s=[];try{u(n).forEach(u=>{const i=t(n,u);e(i).isDirectory()?s.push(...o(i)):(u.endsWith(".vue")||u.endsWith(".js")||u.endsWith(".ts"))&&s.push(i)})}catch(t){}return s}export{s as default,s as uniquePageChunks};
